<script>
const clientId = '162bcf77cc254ffaa8426ef1001c1f7f';
const redirectUri = window.location.origin + window.location.pathname;
let accessToken = '';
let selectedTracks = [];

function login() {
  const scopes = 'playlist-modify-public playlist-modify-private';
  const authUrl = `https://accounts.spotify.com/authorize?client_id=${clientId}&response_type=token&redirect_uri=${encodeURIComponent(redirectUri)}&scope=${encodeURIComponent(scopes)}`;
  window.location.href = authUrl;
}

// --- Recupera token se presente nell'URL
if (window.location.hash.includes('access_token')) {
  accessToken = new URLSearchParams(window.location.hash.substring(1)).get('access_token');
  history.replaceState(null, null, redirectUri);
}

// --- Pulizia titolo
function cleanTitle(title) {
  return title
    .toLowerCase()
    .replace(/\\(.*?\\)/g, '') // Rimuove testo tra parentesi
    .replace(/\\[.*?\\]/g, '') // Rimuove testo tra parentesi quadre
    .replace(/remix|live|version|edit|feat\\.?|acoustic|piano|instrumental/gi, '')
    .replace(/\\s{2,}/g, ' ')
    .trim();
}

// --- Ricerca brani simili su Spotify
async function searchCleanedTrack(originalTitle) {
  const cleaned = cleanTitle(originalTitle);
  const response = await fetch(`https://api.spotify.com/v1/search?q=${encodeURIComponent(cleaned)}&type=track&limit=5`, {
    headers: { Authorization: `Bearer ${accessToken}` }
  });
  const data = await response.json();
  return data.tracks?.items || [];
}

function getPlaylistIdFromUrl(url) {
  const match = url.match(/playlist\\/(\\w+)/);
  return match ? match[1] : null;
}

// --- Applica i filtri e crea playlist
async function startProcessing() {
  if (!accessToken) return alert('Devi effettuare il login prima!');
  const mode = document.querySelector('input[name=\"mode\"]:checked').value;
  const playlistUrl = document.getElementById('playlistLink').value.trim();
  const playlistId = getPlaylistIdFromUrl(playlistUrl);
  if (!playlistId) return alert('Link playlist non valido');

  simulateProgressBar(8000);
  selectedTracks = [];

  // --- Ottiene tutti i brani dalla playlist
  let allTracks = [], offset = 0;
  while (true) {
    const res = await fetch(`https://api.spotify.com/v1/playlists/${playlistId}/tracks?limit=100&offset=${offset}`, {
      headers: { Authorization: `Bearer ${accessToken}` }
    });
    const json = await res.json();
    allTracks.push(...json.items);
    if (!json.next) break;
    offset += 100;
  }

  const exclude = document.getElementById('excludeKeywords').value.toLowerCase().split(',').map(s => s.trim());
  const include = document.getElementById('includeKeywords').value.toLowerCase().split(',').map(s => s.trim());

  const resultContainer = document.getElementById('resultList');
  resultContainer.innerHTML = '';
  resultContainer.innerHTML = `<h3>Risultati trovati:</h3>`;

  for (const item of allTracks) {
    const originalTrack = item.track;
    const candidates = await searchCleanedTrack(originalTrack.name);
    const filtered = candidates.filter(t => {
      const name = t.name.toLowerCase();
      if (exclude.some(word => name.includes(word))) return false;
      if (include[0] && !include.some(word => name.includes(word))) return false;
      return true;
    });

    if (mode === 'auto' && filtered[0]) {
      selectedTracks.push(filtered[0].uri);
    } else if (mode === 'manual') {
      const group = document.createElement('div');
      group.innerHTML = `<strong>${originalTrack.name}</strong><br>`;
      filtered.forEach((track, idx) => {
        const btn = document.createElement('button');
        btn.textContent = `${track.name} â€” ${track.artists.map(a => a.name).join(', ')}`;
        btn.onclick = () => {
          btn.style.background = '#1db954';
          selectedTracks.push(track.uri);
        };
        group.appendChild(btn);
      });
      resultContainer.appendChild(group);
      resultContainer.appendChild(document.createElement('hr'));
    }
  }

  // --- Crea nuova playlist e aggiunge tracce
  const userRes = await fetch(`https://api.spotify.com/v1/me`, {
    headers: { Authorization: `Bearer ${accessToken}` }
  });
  const user = await userRes.json();

  const createRes = await fetch(`https://api.spotify.com/v1/users/${user.id}/playlists`, {
    method: 'POST',
    headers: {
      Authorization: `Bearer ${accessToken}`,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      name: 'ðŸŽ§ Playlist Originale Filtrata',
      description: 'Generata con PlaylistFinder',
      public: false
    })
  });

  const createdPlaylist = await createRes.json();
  for (let i = 0; i < selectedTracks.length; i += 100) {
    const chunk = selectedTracks.slice(i, i + 100);
    await fetch(`https://api.spotify.com/v1/playlists/${createdPlaylist.id}/tracks`, {
      method: 'POST',
      headers: {
        Authorization: `Bearer ${accessToken}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ uris: chunk })
    });
  }

  alert(`âœ… Playlist creata! Vai su Spotify per ascoltarla.`);
}
                                </script>
