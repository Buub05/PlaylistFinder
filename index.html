const clientId = '162bcf77cc254ffaa8426ef1001c1f7f';
const redirectUri = 'https://buub05.github.io/PlaylistFinder/';
let codeVerifier = '';
let accessToken = '';

function generateRandomString(length) {
  const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
  return Array.from(crypto.getRandomValues(new Uint8Array(length)))
    .map(x => chars.charAt(x % chars.length)).join('');
}

async function generateCodeChallenge(codeVerifier) {
  const data = new TextEncoder().encode(codeVerifier);
  const digest = await crypto.subtle.digest('SHA-256', data);
  return btoa(String.fromCharCode(...new Uint8Array(digest)))
    .replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
}

async function login() {
  codeVerifier = generateRandomString(128);
  const codeChallenge = await generateCodeChallenge(codeVerifier);
  localStorage.setItem('code_verifier', codeVerifier);

  const authUrl = `https://accounts.spotify.com/authorize?response_type=code&client_id=${clientId}&scope=playlist-modify-public playlist-modify-private&redirect_uri=${encodeURIComponent(redirectUri)}&code_challenge_method=S256&code_challenge=${codeChallenge}`;
  window.location.href = authUrl;
}

async function handleRedirect() {
  const params = new URLSearchParams(window.location.search);
  const code = params.get("code");
  if (!code) return;

  codeVerifier = localStorage.getItem('code_verifier');

  const body = new URLSearchParams({
    grant_type: 'authorization_code',
    code,
    redirect_uri: redirectUri,
    client_id: clientId,
    code_verifier: codeVerifier
  });

  const res = await fetch('https://accounts.spotify.com/api/token', {
    method: 'POST',
    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
    body
  });

  const data = await res.json();
  accessToken = data.access_token;
  window.history.replaceState({}, document.title, redirectUri);
}
handleRedirect();

function toggleAdvancedMode() {
  const mode = document.querySelector('input[name="mode"]:checked').value;
  document.getElementById('createManualPlaylist').style.display = mode === 'manual' ? 'inline-block' : 'none';
}

function updateDurationRange() {
  const min = document.getElementById('minDuration').value;
  const max = document.getElementById('maxDuration').value;
  document.getElementById('durationRange').innerText = `${min} - ${max}`;
}

function updatePopularityRange() {
  const min = document.getElementById('minPopularity').value;
  const max = document.getElementById('maxPopularity').value;
  document.getElementById('popularityRange').innerText = `${min} - ${max}`;
}

function cleanTitle(title) {
  return title.toLowerCase()
    .replace(/\(.*?\)|\[.*?\]/g, '')
    .replace(/remix|live|version|edit|feat\.?|acoustic|piano|instrumental/gi, '')
    .replace(/\s{2,}/g, ' ').trim();
}

function updateProgress(current, total) {
  const bar = document.getElementById("progressBar");
  const container = document.getElementById("progressBarContainer");
  container.style.display = "block";
  const percent = Math.floor((current / total) * 100);
  bar.style.width = `${percent}%`;
}

async function startProcessing() {
  if (!accessToken) return alert('ðŸ” Devi fare login prima.');
  const mode = document.querySelector('input[name="mode"]:checked').value;
  const playlistUrl = document.getElementById('playlistLink').value.trim();
  const playlistId = playlistUrl.includes('/playlist/') ? playlistUrl.split('/playlist/')[1].split('?')[0] : null;

  const exclude = document.getElementById('excludeKeywords').value.toLowerCase().split(',').map(s => s.trim()).filter(Boolean);
  const include = document.getElementById('includeKeywords').value.toLowerCase().split(',').map(s => s.trim()).filter(Boolean);
  const minDur = parseInt(document.getElementById('minDuration').value || '0');
  const maxDur = parseInt(document.getElementById('maxDuration').value || '7200');
  const minPop = parseInt(document.getElementById('minPopularity').value || '0');
  const maxPop = parseInt(document.getElementById('maxPopularity').value || '100');

  const selectedGenres = Array.from(document.querySelectorAll('#genreList input:checked')).map(el => el.value);
  const customGenres = document.getElementById('customGenres').value.split(',').map(g => g.trim()).filter(Boolean);
  const allGenres = [...selectedGenres, ...customGenres];

  let allTracks = [], offset = 0;
  if (playlistId) {
    while (true) {
      const res = await fetch(`https://api.spotify.com/v1/playlists/${playlistId}/tracks?limit=100&offset=${offset}`, {
        headers: { Authorization: `Bearer ${accessToken}` }
      });
      const json = await res.json();
      allTracks.push(...json.items);
      if (!json.next) break;
      offset += 100;
    }
  }

  const results = [], trackOptions = [];
  document.getElementById('trackSelection').innerHTML = '';
  for (let i = 0; i < allTracks.length; i++) {
    updateProgress(i + 1, allTracks.length);
    const item = allTracks[i];
    const name = cleanTitle(item.track.name);
    const query = encodeURIComponent(name);
    const res = await fetch(`https://api.spotify.com/v1/search?q=${query}&type=track&limit=5`, {
      headers: { Authorization: `Bearer ${accessToken}` }
    });
    const json = await res.json();
    const matches = json.tracks.items.filter(track => {
      const tname = track.name.toLowerCase();
      if (exclude.some(k => tname.includes(k))) return false;
      if (include.length && !include.some(k => tname.includes(k))) return false;
      const dur = track.duration_ms / 1000;
      if (dur < minDur || dur > maxDur) return false;
      const pop = track.popularity;
      if (pop < minPop || pop > maxPop) return false;
      return true;
    });

    if (mode === 'auto') {
      if (matches[0]) results.push(matches[0].uri);
    } else {
      if (matches.length > 0) {
        const container = document.getElementById('trackSelection');
        const div = document.createElement('div');
        div.className = 'track-option';
        const label = document.createElement('label');
        label.innerHTML = `<strong>${item.track.name}</strong> di ${item.track.artists.map(a => a.name).join(',')}<br/>`;
        matches.forEach((track, index) => {
          const id = `${i}_${index}`;
          const title = `${track.name} â€“ ${track.artists.map(a => a.name).join(', ')}`;
          label.innerHTML += `<input type='radio' name='track_${i}' value='${track.uri}' id='${id}'><label for='${id}'> ${title}</label><br/>`;
        });
        div.appendChild(label);
        container.appendChild(div);
      }
    }
  }

  if (mode === 'auto') {
    await createPlaylist(results);
  } else {
    alert('âœ”ï¸ Seleziona le tracce desiderate, poi clicca su \"Crea playlist dai selezionati\"');
  }
}

async function createManualPlaylist() {
  const selected = Array.from(document.querySelectorAll('input[type=radio]:checked')).map(r => r.value);
  await createPlaylist(selected);
}

async function createPlaylist(uris) {
  const user = await (await fetch('https://api.spotify.com/v1/me', {
    headers: { Authorization: `Bearer ${accessToken}` }
  })).json();

  const playlist = await (await fetch(`https://api.spotify.com/v1/users/${user.id}/playlists`, {
    method: 'POST',
    headers: {
      Authorization: `Bearer ${accessToken}`,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({ name: 'ðŸŽ§ Playlist Originale Generata', public: false })
  })).json();

  for (let i = 0; i < uris.length; i += 100) {
    const chunk = uris.slice(i, i + 100);
    await fetch(`https://api.spotify.com/v1/playlists/${playlist.id}/tracks`, {
      method: 'POST',
      headers: { Authorization: `Bearer ${accessToken}`, 'Content-Type': 'application/json' },
      body: JSON.stringify({ uris: chunk })
    });
  }

  alert('âœ… Playlist creata con successo!');
}
