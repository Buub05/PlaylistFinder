<!DOCTYPE html><html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PlaylistFinder</title>
  <style>
    body { background-color: #121212; color: white; font-family: sans-serif; padding: 2rem; text-align: center; }
    input, select, button { margin: 0.5rem; padding: 0.6rem; font-size: 1rem; border-radius: 6px; border: none; }
    button { background-color: #1db954; color: white; cursor: pointer; }
    details { background: #1e1e1e; border-radius: 8px; margin-top: 1rem; padding: 1rem; }
    summary { font-size: 1.2rem; font-weight: bold; cursor: pointer; }
    .inline { display: flex; align-items: center; justify-content: center; gap: 1rem; flex-wrap: wrap; }
    .genre-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.3rem 1rem; justify-items: start; text-align: left; margin: 1rem auto; max-width: 400px; }
    .track-option { background: #1f1f1f; margin: 1rem auto; padding: 1rem; border-radius: 8px; max-width: 800px; text-align: left; }
    #progressBarContainer { width: 80%; background-color: #333; border-radius: 8px; overflow: hidden; margin: 2rem auto 1rem auto; display: none; }
    #progressBar { height: 20px; background-color: #1db954; width: 0%; }
    .range-label { display: block; margin: 0.5rem 0; }
    #resultList, #trackSelection { margin-top: 2rem; max-width: 800px; margin-left: auto; margin-right: auto; text-align: left; }
  </style>
</head>
<body>
  <h1>üéß PlaylistFinder</h1>  <div>
    <label><input type="radio" name="mode" value="auto" checked onchange="toggleAdvancedMode()" /> Automatica</label>
    <label><input type="radio" name="mode" value="manual" onchange="toggleAdvancedMode()" /> Manuale</label>
  </div>  <input type="text" id="playlistLink" placeholder="Link playlist Spotify (facoltativo)" style="width: 80%;" />
  <br/>
  <input type="text" id="playlistName" placeholder="Nome playlist" value="Playlist_1" />
  <input type="file" id="playlistImage" accept="image/*" />
  <br/>
  <button onclick="login()">üîê Login con Spotify</button>  <details>
    <summary>üéöÔ∏è Filtri avanzati</summary>
    <div class="inline">
      <label>Escludi parole: <input type="text" id="excludeKeywords" placeholder="remix, live..." /></label>
      <label>Includi parole: <input type="text" id="includeKeywords" placeholder="acoustic, piano..." /></label>
    </div>
    <div class="inline">
      <label class="range-label">Durata (sec): <span id="durationLabel">0 - 3600</span><br/>
        <input type="range" id="minDuration" min="0" max="3600" value="0" oninput="updateDurationLabel()" />
        <input type="range" id="maxDuration" min="0" max="3600" value="3600" oninput="updateDurationLabel()" />
      </label>
      <label class="range-label">Popolarit√†: <span id="popularityLabel">0 - 100</span><br/>
        <input type="range" id="minPopularity" min="0" max="100" value="0" oninput="updatePopularityLabel()" />
        <input type="range" id="maxPopularity" min="0" max="100" value="100" oninput="updatePopularityLabel()" />
      </label>
    </div>
    <div class="inline">
      <label>BPM min: <input type="number" id="minBPM" placeholder="es. 80" style="width:5rem" /></label>
      <label>BPM max: <input type="number" id="maxBPM" placeholder="es. 160" style="width:5rem" /></label>
      <label>Energia: <input type="number" id="minEnergy" placeholder="0.0" min="0" max="1" step="0.1" style="width:5rem" /></label>
      <label>Valenza: <input type="number" id="minValence" placeholder="0.0" min="0" max="1" step="0.1" style="width:5rem" /></label>
    </div>
    <div class="inline">
      <label>Generi:</label>
      <div class="genre-grid" id="genreList">
        <label><input type="checkbox" value="pop" /> Pop</label>
        <label><input type="checkbox" value="rock" /> Rock</label>
        <label><input type="checkbox" value="hip-hop" /> Hip-Hop</label>
        <label><input type="checkbox" value="classical" /> Classica</label>
        <label><input type="checkbox" value="acoustic" /> Acustico</label>
        <label><input type="checkbox" value="piano" /> Piano</label>
        <label><input type="checkbox" value="instrumental" /> Instrumental</label>
        <label><input type="checkbox" value="remix" /> Remix</label>
        <label><input type="checkbox" value="edm" /> EDM</label>
        <label><input type="checkbox" value="jazz" /> Jazz</label>
      </div>
      <input type="text" id="customGenres" placeholder="Aggiungi altri generi separati da virgole" style="width: 100%;" />
    </div>
  </details>  <div style="margin-top: 2rem">
    <button onclick="startProcessing()">üéØ Crea nuova playlist</button>
    <button onclick="createManualPlaylist()" id="createManualPlaylist" style="display:none">‚úÖ Conferma selezione</button>
    <button onclick="exportCSV()">üìÑ Esporta CSV</button>
  </div>  <div id="progressBarContainer"><div id="progressBar"></div></div>
  <div id="trackSelection"></div>
  <div id="resultList"></div>  <script>
    // JavaScript sar√† inserito nel prossimo messaggio per mantenere leggibilit√†
  // === Variabili globali === const clientId = '162bcf77cc254ffaa8426ef1001c1f7f'; const redirectUri = 'https://buub05.github.io/PlaylistFinder/'; let accessToken = ''; let codeVerifier = ''; let foundTracks = [];

// === Login con Spotify === function generateRandomString(length) { const charset = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789'; return Array.from(crypto.getRandomValues(new Uint8Array(length))).map(x => charset[x % charset.length]).join(''); }

async function generateCodeChallenge(codeVerifier) { const data = new TextEncoder().encode(codeVerifier); const digest = await crypto.subtle.digest('SHA-256', data); return btoa(String.fromCharCode(...new Uint8Array(digest))).replace(/+/g, '-').replace(///g, '_').replace(/=+$/, ''); }

function login() { codeVerifier = generateRandomString(128); generateCodeChallenge(codeVerifier).then(codeChallenge => { localStorage.setItem('code_verifier', codeVerifier); const url = 'https://accounts.spotify.com/authorize' + ?response_type=code&client_id=${clientId} + &scope=playlist-modify-public playlist-modify-private user-read-private + &redirect_uri=${encodeURIComponent(redirectUri)} + &code_challenge_method=S256&code_challenge=${codeChallenge}; window.location.href = url; }); }

async function handleRedirect() { const params = new URLSearchParams(window.location.search); const code = params.get('code'); if (!code) return; codeVerifier = localStorage.getItem('code_verifier');

const body = new URLSearchParams({ client_id: clientId, grant_type: 'authorization_code', code, redirect_uri: redirectUri, code_verifier: codeVerifier });

const response = await fetch('https://accounts.spotify.com/api/token', { method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body }); const data = await response.json(); accessToken = data.access_token; window.history.replaceState({}, document.title, '/'); } handleRedirect();

// === Filtri e UI === function updateDurationLabel() { const min = document.getElementById('minDuration').value; const max = document.getElementById('maxDuration').value; document.getElementById('durationLabel').textContent = ${min} - ${max}; } function updatePopularityLabel() { const min = document.getElementById('minPopularity').value; const max = document.getElementById('maxPopularity').value; document.getElementById('popularityLabel').textContent = ${min} - ${max}; }

function toggleAdvancedMode() { const manual = document.querySelector('input[name="mode"]:checked').value === 'manual'; document.getElementById('createManualPlaylist').style.display = manual ? 'inline-block' : 'none'; }

// === Pulizia e ricerca === function cleanTitle(title) { return title.toLowerCase().replace(/|/g, '').replace(/[^\w\s]/g, '').replace(/\s{2,}/g, ' ').trim(); }

// === Avvio processo === async function startProcessing() { if (!accessToken) return alert('Effettua il login con Spotify prima.'); foundTracks = [];

const playlistUrl = document.getElementById('playlistLink').value.trim(); const playlistId = playlistUrl.split('/playlist/')[1]?.split('?')[0]; if (!playlistId) return alert("Inserisci un link valido di playlist Spotify");

const exclude = document.getElementById('excludeKeywords').value.toLowerCase().split(',').map(t => t.trim()); const include = document.getElementById('includeKeywords').value.toLowerCase().split(',').map(t => t.trim()); const minDur = parseInt(document.getElementById('minDuration').value); const maxDur = parseInt(document.getElementById('maxDuration').value); const minPop = parseInt(document.getElementById('minPopularity').value); const maxPop = parseInt(document.getElementById('maxPopularity').value); const genres = [...document.querySelectorAll('#genreList input:checked')].map(i => i.value); const customGenres = document.getElementById('customGenres').value.split(',').map(g => g.trim()); const allGenres = [...genres, ...customGenres];

const mode = document.querySelector('input[name="mode"]:checked').value; const container = document.getElementById("progressBar"); const progressDiv = document.getElementById("progressBarContainer"); container.style.width = "0%"; progressDiv.style.display = "block";

let offset = 0; let allTracks = []; while (true) { const res = await fetch(https://api.spotify.com/v1/playlists/${playlistId}/tracks?limit=100&offset=${offset}, { headers: { Authorization: Bearer ${accessToken} } }); const json = await res.json(); allTracks.push(...json.items); if (!json.next) break; offset += 100; }

for (let i = 0; i < allTracks.length; i++) { const item = allTracks[i]; const title = cleanTitle(item.track.name); const query = encodeURIComponent(title); const res = await fetch(https://api.spotify.com/v1/search?q=${query}&type=track&limit=5, { headers: { Authorization: Bearer ${accessToken} } }); const result = await res.json(); const filtered = result.tracks.items.filter(t => { const name = t.name.toLowerCase(); const dur = t.duration_ms / 1000; if (exclude.some(k => name.includes(k))) return false; if (include[0] && !include.some(k => name.includes(k))) return false; if (dur < minDur || dur > maxDur) return false; if (t.popularity < minPop || t.popularity > maxPop) return false; return true; }); foundTracks.push({ original: item.track.name, matches: filtered }); container.style.width = ${Math.round(((i + 1) / allTracks.length) * 100)}%; }

if (mode === 'manual') renderSelection(); else await createAutoPlaylist(); }

// === Manuale: selezione === function renderSelection() { const div = document.getElementById('trackSelection'); div.innerHTML = ''; foundTracks.forEach((track, i) => { const container = document.createElement('div'); container.className = 'track-option'; container.innerHTML = <strong>${track.original}</strong><br/> + track.matches.map((m, j) => <label><input type="radio" name="track-${i}" value="${m.uri}" ${j === 0 ? 'checked' : ''}> ${m.name} - ${m.artists[0].name}</label><br/> ).join(''); div.appendChild(container); }); }

async function createManualPlaylist() { const selectedURIs = []; foundTracks.forEach((track, i) => { const radio = document.querySelector(input[name="track-${i}"]:checked); if (radio) selectedURIs.push(radio.value); }); await createPlaylist(selectedURIs); }

async function createAutoPlaylist() { const uris = foundTracks.map(t => t.matches[0]?.uri).filter(Boolean); await createPlaylist(uris); }

async function createPlaylist(uris) { const name = document.getElementById('playlistName').value || 'Playlist_1'; const user = await (await fetch('https://api.spotify.com/v1/me', { headers: { Authorization: Bearer ${accessToken} } })).json(); const playlist = await (await fetch(https://api.spotify.com/v1/users/${user.id}/playlists, { method: 'POST', headers: { Authorization: Bearer ${accessToken}, 'Content-Type': 'application/json' }, body: JSON.stringify({ name, public: false }) })).json();

for (let i = 0; i < uris.length; i += 100) { const chunk = uris.slice(i, i + 100); await fetch(https://api.spotify.com/v1/playlists/${playlist.id}/tracks, { method: 'POST', headers: { Authorization: Bearer ${accessToken} }, body: JSON.stringify({ uris: chunk }) }); } alert('‚úÖ Playlist creata!'); }

function exportCSV() { let csv = 'Titolo originale,Scelte trovate\n'; foundTracks.forEach(t => { const names = t.matches.map(m => ${m.name} - ${m.artists.map(a => a.name).join(', ')}).join('; '); csv += "${t.original}","${names}"\n; }); const blob = new Blob([csv], { type: 'text/csv' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'playlist_results.csv'; a.click(); }

  
  </script></body>
</html>
