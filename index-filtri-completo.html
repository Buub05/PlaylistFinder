
<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Playlist Filtrata Spotify</title>
  <style>
    body {
      background: #121212;
      color: white;
      font-family: sans-serif;
      padding: 2rem;
      text-align: center;
    }
    button {
      background-color: #1db954;
      color: white;
      font-size: 1rem;
      padding: 1rem 2rem;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      margin: 1rem;
    }
    input, select {
      padding: 0.6rem;
      margin-top: 0.5rem;
      width: 80%;
    }
  </style>
</head>
<body>
  <h1>üéß Crea playlist filtrata</h1>
  <button onclick="login()">Login con Spotify</button>

  <div style="margin-top: 2rem;">
    <input type="text" id="playlistLink" placeholder="Incolla il link della playlist" /><br/>
    <h3>üéöÔ∏è Acousticness</h3>
    <select id="acousticFilter">
      <option value="none">Nessun filtro</option>
      <option value="with">Con</option>
      <option value="without">Senza</option>
      <option value="only">Solo</option>
    </select>

    <h3>üéº Instrumentalness</h3>
    <select id="instrumentalFilter">
      <option value="none">Nessun filtro</option>
      <option value="with">Con</option>
      <option value="without">Senza</option>
      <option value="only">Solo</option>
    </select>

    <h3>üìä Popularit√† minima</h3>
    <input type="range" id="popularityRange" min="0" max="100" value="50" oninput="document.getElementById('popVal').textContent = this.value" />
    <span id="popVal">50</span>+

    <br/><br/>
    <button onclick="process()">üéØ Crea playlist filtrata</button>
  </div>

  <script>
    const clientId = "162bcf77cc254ffaa8426ef1001c1f7f";
    const redirectUri = "https://buub05.github.io/PlaylistFinder/";
    const scope = "playlist-read-private playlist-modify-private playlist-modify-public";

    function login() {
      const verifier = [...Array(128)].map(() => Math.random().toString(36)[2]).join('');
      localStorage.setItem("code_verifier", verifier);
      const encoder = new TextEncoder();
      crypto.subtle.digest("SHA-256", encoder.encode(verifier)).then(hash => {
        const challenge = btoa(String.fromCharCode(...new Uint8Array(hash)))
          .replace(/\+/g, "-").replace(/\//g, "_").replace(/=+$/, "");
        const url = \`https://accounts.spotify.com/authorize?client_id=\${clientId}&response_type=code&redirect_uri=\${encodeURIComponent(redirectUri)}&scope=\${encodeURIComponent(scope)}&code_challenge_method=S256&code_challenge=\${challenge}\`;
        window.location.href = url;
      });
    }

    async function getToken() {
      const params = new URLSearchParams(window.location.search);
      const code = params.get("code");
      if (!code) return null;

      const verifier = localStorage.getItem("code_verifier");
      const body = new URLSearchParams({
        grant_type: "authorization_code",
        code,
        redirect_uri: redirectUri,
        client_id: clientId,
        code_verifier: verifier
      });

      const res = await fetch("https://accounts.spotify.com/api/token", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body
      });
      const data = await res.json();
      return data.access_token;
    }

    async function process() {
      const accessToken = await getToken();
      if (!accessToken) return alert("Devi prima fare il login.");

      const link = document.getElementById("playlistLink").value.trim();
      const match = link.match(/playlist\/([a-zA-Z0-9]+)/);
      if (!match) return alert("Link playlist non valido.");
      const playlistId = match[1];

      const tracksRes = await fetch(\`https://api.spotify.com/v1/playlists/\${playlistId}/tracks?limit=100\`, {
        headers: { Authorization: \`Bearer \${accessToken}\` }
      });
      const tracks = await tracksRes.json();
      const uris = [];

      for (const item of tracks.items) {
        const id = item.track.id;
        const featuresRes = await fetch(\`https://api.spotify.com/v1/audio-features/\${id}\`, {
          headers: { Authorization: \`Bearer \${accessToken}\` }
        });
        const feat = await featuresRes.json();
        const pop = item.track.popularity;

        // Filtri
        const acousticOpt = document.getElementById("acousticFilter").value;
        const instrumentalOpt = document.getElementById("instrumentalFilter").value;
        const popularityMin = parseInt(document.getElementById("popularityRange").value);

        if (pop < popularityMin) continue;

        if ((acousticOpt === "only" && feat.acousticness < 0.5) ||
            (acousticOpt === "without" && feat.acousticness > 0.5) ||
            (acousticOpt === "with" && feat.acousticness < 0.3)) continue;

        if ((instrumentalOpt === "only" && feat.instrumentalness < 0.5) ||
            (instrumentalOpt === "without" && feat.instrumentalness > 0.5) ||
            (instrumentalOpt === "with" && feat.instrumentalness < 0.3)) continue;

        uris.push(item.track.uri);
      }

      const meRes = await fetch("https://api.spotify.com/v1/me", {
        headers: { Authorization: \`Bearer \${accessToken}\` }
      });
      const me = await meRes.json();

      const plCreate = await fetch(\`https://api.spotify.com/v1/users/\${me.id}/playlists\`, {
        method: "POST",
        headers: {
          Authorization: \`Bearer \${accessToken}\`,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ name: "Playlist filtrata", public: false })
      });
      const newPl = await plCreate.json();

      for (let i = 0; i < uris.length; i += 100) {
        await fetch(\`https://api.spotify.com/v1/playlists/\${newPl.id}/tracks\`, {
          method: "POST",
          headers: {
            Authorization: \`Bearer \${accessToken}\`,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ uris: uris.slice(i, i + 100) })
        });
      }

      alert("‚úÖ Playlist filtrata creata con successo!");
    }

    window.onload = getToken;
  </script>
</body>
</html>
